<div class="user-management">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>User Management</h1>
      <p class="subtitle">Manage users in your organization</p>
    </div>
    <div class="header-right">
      <button 
        class="btn btn-primary" 
        *hasPermission="Permission.UserCreate"
        (click)="openCreateModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        Add User
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-value">{{ users().length }}</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-value active">{{ activeUsers() }}</div>
      <div class="stat-label">Active</div>
    </div>
    <div class="stat-card">
      <div class="stat-value inactive">{{ inactiveUsers() }}</div>
      <div class="stat-label">Inactive</div>
    </div>
  </div>

  <!-- Success Alert -->
  @if (successMessage()) {
    <div class="alert alert-success">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
      </svg>
      {{ successMessage() }}
      <button class="close-btn" (click)="dismissSuccess()">&times;</button>
    </div>
  }

  <!-- Error Alert -->
  @if (error()) {
    <div class="alert alert-error">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 8v4M12 16h.01"/>
      </svg>
      {{ error() }}
      <button class="close-btn" (click)="dismissError()">&times;</button>
    </div>
  }

  <!-- Search -->
  <div class="search-bar">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/>
      <path d="M21 21l-4.35-4.35"/>
    </svg>
    <input 
      type="text" 
      placeholder="Search users by name or email..."
      [ngModel]="searchQuery()"
      (ngModelChange)="searchQuery.set($event)"
    />
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading users...</p>
    </div>
  }

  <!-- User Table -->
  @if (!loading() && filteredUsers().length > 0) {
    <div class="table-container">
      <table class="user-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Role</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of filteredUsers(); track user.user_id) {
            <tr [class.inactive-row]="!user.is_active">
              <td class="user-cell">
                <div class="user-avatar">{{ user.name.charAt(0).toUpperCase() }}</div>
                <div class="user-info">
                  <div class="user-name">{{ user.name }}</div>
                  <div class="user-email">{{ user.email }}</div>
                </div>
              </td>
              <td>
                <div class="role-info">
                  <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
                    {{ getRoleDisplayName(user.role) }}
                  </span>
                  @if (getRoleInfo(user.role); as roleInfo) {
                    <span class="permission-count" title="Click to view permissions">
                      {{ roleInfo.permissions.length }} permissions
                    </span>
                  }
                </div>
              </td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(user.is_active)">
                  {{ user.is_active ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td class="actions-cell">
                <button 
                  class="btn-icon" 
                  title="Edit user"
                  *hasPermission="Permission.UserUpdate"
                  (click)="openEditModal(user)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                <button 
                  class="btn-icon" 
                  title="Reset password"
                  *hasPermission="Permission.UserUpdate"
                  (click)="openResetPasswordModal(user)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                  </svg>
                </button>
                <button 
                  class="btn-icon"
                  [title]="user.is_active ? 'Deactivate user' : 'Reactivate user'"
                  *hasPermission="Permission.UserUpdate"
                  (click)="toggleUserActive(user)">
                  @if (user.is_active) {
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <path d="M4.93 4.93l14.14 14.14"/>
                    </svg>
                  } @else {
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                      <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                  }
                </button>
                <button 
                  class="btn-icon btn-danger" 
                  title="Delete user permanently"
                  *hasPermission="Permission.UserDelete"
                  (click)="deleteUser(user)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && filteredUsers().length === 0) {
    <div class="empty-state">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      <p>No users found</p>
      @if (searchQuery()) {
        <span>Try adjusting your search</span>
      }
    </div>
  }
</div>

<!-- Create User Modal -->
@if (showCreateModal()) {
  <div class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Create New User</h2>
        <button class="close-btn" (click)="closeCreateModal()">&times;</button>
      </div>
      <form [formGroup]="createForm" (ngSubmit)="submitCreate()">
        <div class="modal-body">
          <div class="form-group">
            <label for="create-email">Email</label>
            <input type="email" id="create-email" formControlName="email" placeholder="user@example.com"/>
          </div>
          <div class="form-group">
            <label for="create-name">Name</label>
            <input type="text" id="create-name" formControlName="name" placeholder="Full name"/>
          </div>
          <div class="form-group">
            <label for="create-password">Password</label>
            <input type="password" id="create-password" formControlName="password" placeholder="Minimum 8 characters"/>
          </div>
          <div class="form-group">
            <label for="create-role">Role</label>
            <select id="create-role" formControlName="role">
              @for (roleOption of allRoleOptions(); track roleOption.value) {
                <option [value]="roleOption.value">{{ roleOption.label }} - {{ roleOption.description }}</option>
              }
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="createForm.invalid">Create User</button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Edit User Modal (with tabbed project assignment) -->
@if (showEditModal()) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Edit User</h2>
        <button class="close-btn" (click)="closeEditModal()">&times;</button>
      </div>
      
      <!-- User Info Header -->
      <div class="user-preview">
        <div class="user-avatar large">{{ selectedUser()?.name?.charAt(0)?.toUpperCase() }}</div>
        <div class="user-email">{{ selectedUser()?.email }}</div>
      </div>
      
      <!-- Tab Navigation -->
      <div class="modal-tabs">
        <button 
          class="tab-btn" 
          [class.active]="editModalTab() === 'details'"
          (click)="switchEditTab('details')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
            <circle cx="12" cy="7" r="4"/>
          </svg>
          User Details
        </button>
        <button 
          class="tab-btn" 
          [class.active]="editModalTab() === 'projects'"
          *hasPermission="Permission.ProjectManageMembers"
          (click)="switchEditTab('projects')">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
          Project Access
        </button>
      </div>
      
      <!-- Details Tab -->
      @if (editModalTab() === 'details') {
        <form [formGroup]="editForm" (ngSubmit)="submitEdit()">
          <div class="modal-body">
            <div class="form-group">
              <label for="edit-name">Name</label>
              <input type="text" id="edit-name" formControlName="name"/>
            </div>
            <div class="form-group" *hasPermission="Permission.UserManageRoles">
              <label for="edit-role">Role</label>
              <select id="edit-role" formControlName="role">
                @for (roleOption of allRoleOptions(); track roleOption.value) {
                  <option [value]="roleOption.value">{{ roleOption.label }}</option>
                }
              </select>
              @if (getRoleInfo(editForm.value.role || ''); as roleInfo) {
                <div class="role-permissions-preview">
                  <span class="permissions-label">Permissions ({{ roleInfo.permissions.length }}):</span>
                  <div class="permissions-list">
                    @for (perm of roleInfo.permissions.slice(0, 5); track perm) {
                      <span class="permission-tag">{{ perm }}</span>
                    }
                    @if (roleInfo.permissions.length > 5) {
                      <span class="permission-tag more">+{{ roleInfo.permissions.length - 5 }} more</span>
                    }
                  </div>
                </div>
              }
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" formControlName="is_active"/>
                User is active
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
            <button type="submit" class="btn btn-primary" [disabled]="editForm.invalid">Save Changes</button>
          </div>
        </form>
      }
      
      <!-- Projects Tab -->
      @if (editModalTab() === 'projects') {
        <div class="modal-body">
          <!-- Currently Assigned Projects -->
          @if (loadingMemberships()) {
            <div class="loading-memberships">
              <span class="spinner-sm"></span> Loading project assignments...
            </div>
          } @else if (userMemberships().length > 0) {
            <div class="form-group">
              <label>Currently Assigned Projects</label>
              <div class="assigned-projects-list">
                @for (membership of userMemberships(); track membership.project_id) {
                  <div class="assigned-project-item">
                    <div class="project-info">
                      <span class="project-name">{{ membership.project_name }}</span>
                      <span class="project-role">{{ membership.role_name }}</span>
                    </div>
                    <button 
                      type="button" 
                      class="btn btn-sm btn-danger" 
                      title="Remove from project"
                      (click)="removeProjectAssignment(membership.project_id)">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                      </svg>
                    </button>
                  </div>
                }
              </div>
            </div>
          }
          
          <div class="form-group">
            <label>Add to Projects</label>
            @if (projects().length === 0) {
              <p class="hint-text">No projects available. Create a project first.</p>
            } @else {
              <div class="project-checklist">
                @for (project of projects(); track project.project_id) {
                  <label class="checkbox-item" [class.selected]="isProjectSelected(project.project_id)">
                    <input 
                      type="checkbox" 
                      [checked]="isProjectSelected(project.project_id)"
                      (change)="toggleProjectSelection(project.project_id)">
                    <div class="project-info">
                      <span class="project-name">{{ project.name }}</span>
                      @if (project.description) {
                        <span class="project-desc">{{ project.description }}</span>
                      }
                      @if (isUserAssignedToProject(project.project_id)) {
                        <span class="already-assigned-badge">Assigned</span>
                      }
                    </div>
                  </label>
                }
              </div>
              <span class="hint-text">{{ selectedProjectIds().length }} project(s) selected</span>
            }
          </div>
          
          <div class="info-box">
            <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 16v-4M12 8h.01"/>
            </svg>
            <p>Select projects to give the user access. They will be assigned as Project Member.</p>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
          <button 
            type="button" 
            class="btn btn-primary" 
            [disabled]="selectedProjectIds().length === 0" 
            (click)="submitAssignProjects()">
            Assign to {{ selectedProjectIds().length }} Project(s)
          </button>
        </div>
      }
    </div>
  </div>
}

<!-- Reset Password Modal -->
@if (showResetPasswordModal()) {
  <div class="modal-overlay" (click)="closeResetPasswordModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Reset Password</h2>
        <button class="close-btn" (click)="closeResetPasswordModal()">&times;</button>
      </div>
      <form [formGroup]="resetPasswordForm" (ngSubmit)="submitResetPassword()">
        <div class="modal-body">
          <p class="info-text">Setting a new password for <strong>{{ selectedUser()?.name }}</strong></p>
          <div class="form-group">
            <label for="new-password">New Password</label>
            <input type="password" id="new-password" formControlName="new_password" placeholder="Minimum 8 characters"/>
          </div>
          <div class="form-group">
            <label for="confirm-password">Confirm Password</label>
            <input type="password" id="confirm-password" formControlName="confirm_password" placeholder="Repeat password"/>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeResetPasswordModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="resetPasswordForm.invalid">Reset Password</button>
        </div>
      </form>
    </div>
  </div>
}

