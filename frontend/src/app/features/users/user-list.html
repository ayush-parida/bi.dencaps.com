<div class="user-management">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <h1>User Management</h1>
      <p class="subtitle">Manage users in your organization</p>
    </div>
    <div class="header-right">
      <button 
        class="btn btn-primary" 
        *hasPermission="Permission.UserCreate"
        (click)="openCreateModal()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 5v14M5 12h14"/>
        </svg>
        Add User
      </button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-value">{{ users().length }}</div>
      <div class="stat-label">Total Users</div>
    </div>
    <div class="stat-card">
      <div class="stat-value active">{{ activeUsers() }}</div>
      <div class="stat-label">Active</div>
    </div>
    <div class="stat-card">
      <div class="stat-value inactive">{{ inactiveUsers() }}</div>
      <div class="stat-label">Inactive</div>
    </div>
  </div>

  <!-- Error Alert -->
  @if (error()) {
    <div class="alert alert-error">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 8v4M12 16h.01"/>
      </svg>
      {{ error() }}
      <button class="close-btn" (click)="error.set(null)">&times;</button>
    </div>
  }

  <!-- Search -->
  <div class="search-bar">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <circle cx="11" cy="11" r="8"/>
      <path d="M21 21l-4.35-4.35"/>
    </svg>
    <input 
      type="text" 
      placeholder="Search users by name or email..."
      [ngModel]="searchQuery()"
      (ngModelChange)="searchQuery.set($event)"
    />
  </div>

  <!-- Loading -->
  @if (loading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading users...</p>
    </div>
  }

  <!-- User Table -->
  @if (!loading() && filteredUsers().length > 0) {
    <div class="table-container">
      <table class="user-table">
        <thead>
          <tr>
            <th>User</th>
            <th>Role</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of filteredUsers(); track user.user_id) {
            <tr [class.inactive-row]="!user.is_active">
              <td class="user-cell">
                <div class="user-avatar">{{ user.name.charAt(0).toUpperCase() }}</div>
                <div class="user-info">
                  <div class="user-name">{{ user.name }}</div>
                  <div class="user-email">{{ user.email }}</div>
                </div>
              </td>
              <td>
                <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
                  {{ user.role | titlecase }}
                </span>
              </td>
              <td>
                <span class="status-badge" [ngClass]="getStatusClass(user.is_active)">
                  {{ user.is_active ? 'Active' : 'Inactive' }}
                </span>
              </td>
              <td class="actions-cell">
                <button 
                  class="btn-icon" 
                  title="Edit user"
                  *hasPermission="Permission.UserUpdate"
                  (click)="openEditModal(user)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                </button>
                <button 
                  class="btn-icon" 
                  title="Reset password"
                  *hasPermission="Permission.UserUpdate"
                  (click)="openResetPasswordModal(user)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                  </svg>
                </button>
                <button 
                  class="btn-icon"
                  [title]="user.is_active ? 'Deactivate user' : 'Reactivate user'"
                  *hasPermission="Permission.UserUpdate"
                  (click)="toggleUserActive(user)">
                  @if (user.is_active) {
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <circle cx="12" cy="12" r="10"/>
                      <path d="M4.93 4.93l14.14 14.14"/>
                    </svg>
                  } @else {
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                      <polyline points="22 4 12 14.01 9 11.01"/>
                    </svg>
                  }
                </button>
                <button 
                  class="btn-icon btn-danger" 
                  title="Delete user permanently"
                  *hasPermission="Permission.UserDelete"
                  (click)="deleteUser(user)">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Empty State -->
  @if (!loading() && filteredUsers().length === 0) {
    <div class="empty-state">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
      <p>No users found</p>
      @if (searchQuery()) {
        <span>Try adjusting your search</span>
      }
    </div>
  }
</div>

<!-- Create User Modal -->
@if (showCreateModal()) {
  <div class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Create New User</h2>
        <button class="close-btn" (click)="closeCreateModal()">&times;</button>
      </div>
      <form [formGroup]="createForm" (ngSubmit)="submitCreate()">
        <div class="modal-body">
          <div class="form-group">
            <label for="create-email">Email</label>
            <input type="email" id="create-email" formControlName="email" placeholder="user@example.com"/>
          </div>
          <div class="form-group">
            <label for="create-name">Name</label>
            <input type="text" id="create-name" formControlName="name" placeholder="Full name"/>
          </div>
          <div class="form-group">
            <label for="create-password">Password</label>
            <input type="password" id="create-password" formControlName="password" placeholder="Minimum 8 characters"/>
          </div>
          <div class="form-group">
            <label for="create-role">Role</label>
            <select id="create-role" formControlName="role">
              <option value="viewer">Viewer</option>
              <option value="project_member">Project Member</option>
              <option value="project_owner">Project Owner</option>
              <option value="admin">Admin</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="createForm.invalid">Create User</button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Edit User Modal -->
@if (showEditModal()) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Edit User</h2>
        <button class="close-btn" (click)="closeEditModal()">&times;</button>
      </div>
      <form [formGroup]="editForm" (ngSubmit)="submitEdit()">
        <div class="modal-body">
          <div class="user-preview">
            <div class="user-avatar large">{{ selectedUser()?.name?.charAt(0)?.toUpperCase() }}</div>
            <div class="user-email">{{ selectedUser()?.email }}</div>
          </div>
          <div class="form-group">
            <label for="edit-name">Name</label>
            <input type="text" id="edit-name" formControlName="name"/>
          </div>
          <div class="form-group" *hasPermission="Permission.UserManageRoles">
            <label for="edit-role">Role</label>
            <select id="edit-role" formControlName="role">
              <option value="viewer">Viewer</option>
              <option value="project_member">Project Member</option>
              <option value="project_owner">Project Owner</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" formControlName="is_active"/>
              User is active
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="editForm.invalid">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
}

<!-- Reset Password Modal -->
@if (showResetPasswordModal()) {
  <div class="modal-overlay" (click)="closeResetPasswordModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Reset Password</h2>
        <button class="close-btn" (click)="closeResetPasswordModal()">&times;</button>
      </div>
      <form [formGroup]="resetPasswordForm" (ngSubmit)="submitResetPassword()">
        <div class="modal-body">
          <p class="info-text">Setting a new password for <strong>{{ selectedUser()?.name }}</strong></p>
          <div class="form-group">
            <label for="new-password">New Password</label>
            <input type="password" id="new-password" formControlName="new_password" placeholder="Minimum 8 characters"/>
          </div>
          <div class="form-group">
            <label for="confirm-password">Confirm Password</label>
            <input type="password" id="confirm-password" formControlName="confirm_password" placeholder="Repeat password"/>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeResetPasswordModal()">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="resetPasswordForm.invalid">Reset Password</button>
        </div>
      </form>
    </div>
  </div>
}
