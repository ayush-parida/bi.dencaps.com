<div class="chat-container">
  <!-- Main chat area (sidebar removed - now in layout) -->
  <main class="chat-main">
    <div class="chat-header">
      <div class="header-left">
        <h1>{{ chatTitle() }}</h1>
      </div>
      <div class="header-right">
        <div class="project-selector">
          <label>Project:</label>
          <select 
            class="project-dropdown" 
            [ngModel]="projectId()" 
            (ngModelChange)="onProjectChange($event)">
            <option value="">Select a project...</option>
            @for (proj of projects(); track proj.project_id) {
              <option [value]="proj.project_id">{{ proj.name }}</option>
            }
          </select>
        </div>
      </div>
    </div>

    <!-- Loading state -->
    @if (isLoading()) {
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading conversation...</p>
      </div>
    } @else {
      <!-- Messages area -->
      <div class="messages-container">
        @if (messages().length === 0) {
          <div class="welcome-message">
            <h2>Welcome to DencapsBI Chat</h2>
            @if (project()) {
              <p>Ask me anything about <strong>{{ project()!.name }}</strong> or data analysis.</p>
            } @else {
              <p>Select a project from the dropdown above to start chatting.</p>
            }
            <div class="suggestions">
              <p>Try asking:</p>
              <ul>
                <li>"How do I analyze sales trends?"</li>
                <li>"What visualization should I use for time-series data?"</li>
                <li>"Explain SQL JOIN operations"</li>
              </ul>
            </div>
          </div>
        } @else {
          <div class="messages-list">
            @for (message of messages(); track trackByIndex($index)) {
              <div class="message" [class]="'message-' + message.role">
                <div class="message-avatar">
                  @if (message.role === 'user') {
                    <span class="avatar-icon user-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                        <circle cx="12" cy="7" r="4"></circle>
                      </svg>
                    </span>
                  } @else {
                    <span class="avatar-icon ai-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m9 0a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3"></path>
                      </svg>
                    </span>
                  }
                </div>
                <div class="message-content">
                  <div class="message-header">
                    <span class="message-role">{{ message.role === 'user' ? 'You' : 'AI Assistant' }}</span>
                    <span class="message-time">{{ formatTimestamp(message.timestamp) }}</span>
                  </div>
                  
                  @if (isStructuredContent(message)) {
                    <app-content-renderer [response]="message.structured_content"></app-content-renderer>
                  } @else {
                    @if (tryParseStructuredContent(message.content); as structuredData) {
                      <app-content-renderer [response]="structuredData"></app-content-renderer>
                    } @else {
                      <app-markdown-renderer [content]="message.content"></app-markdown-renderer>
                    }
                  }
                </div>
              </div>
            }
            
            @if (isSending()) {
              <div class="message message-assistant">
                <div class="message-avatar">
                  <span class="avatar-icon ai-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3m9 0a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3"></path>
                    </svg>
                  </span>
                </div>
                <div class="message-content">
                  <div class="message-header">
                    <span class="message-role">AI Assistant</span>
                  </div>
                  <div class="message-text typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                  </div>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Error display -->
    @if (error()) {
      <div class="error-banner">
        <span class="error-icon">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
            <line x1="12" y1="9" x2="12" y2="13"></line>
            <line x1="12" y1="17" x2="12.01" y2="17"></line>
          </svg>
        </span>
        <span class="error-text">{{ error() }}</span>
        <button class="error-close" (click)="error.set(null)">✕</button>
      </div>
    }

    <!-- Input area -->
    <div class="input-area">
      <div class="input-container">
        <textarea
          class="message-input"
          [(ngModel)]="messageInput"
          (keypress)="onKeyPress($event)"
          [disabled]="isSending() || !projectId()"
          placeholder="Type your message... (Press Enter to send, Shift+Enter for new line)"
          rows="3"></textarea>
        <button 
          class="send-button"
          (click)="sendMessage()"
          [disabled]="!messageInput.trim() || isSending() || !projectId()">
          @if (isSending()) {
            <span class="button-spinner"></span>
          } @else {
            <span>Send ➤</span>
          }
        </button>
      </div>
    </div>
  </main>
</div>
